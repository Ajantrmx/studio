{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user within the Güvenli İz application, storing non-sensitive profile information and linking to an external authentication system's user ID.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity, typically mapping to an external authentication system's user ID."
        },
        "displayName": {
          "type": "string",
          "description": "The user's chosen display name or nickname within the application."
        },
        "email": {
          "type": "string",
          "description": "The user's email address, used for communication purposes (not for authentication).",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "The timestamp when this user profile was created in the application.",
          "format": "date-time"
        }
      },
      "required": [
        "id"
      ]
    },
    "TrackerSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TrackerSession",
      "type": "object",
      "description": "Represents an active or historical tracking session initiated by a 'Transmitter'. It holds the unique code used by 'Receivers' to track the transmitter's location.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TrackerSession entity."
        },
        "trackingCode": {
          "type": "string",
          "description": "The unique alphanumeric code generated by AI for this tracking session, which 'Receivers' enter to initiate tracking."
        },
        "transmitterUserId": {
          "type": "string",
          "description": "Reference to the UserProfile who is acting as the transmitter for this session. (Relationship: UserProfile 1:N TrackerSession)"
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates whether the tracking session is currently active and broadcasting location data."
        },
        "createdAt": {
          "type": "string",
          "description": "The timestamp when the tracking session was initiated.",
          "format": "date-time"
        },
        "lastKnownLatitude": {
          "type": "number",
          "description": "The most recent known latitude coordinate of the transmitter."
        },
        "lastKnownLongitude": {
          "type": "number",
          "description": "The most recent known longitude coordinate of the transmitter."
        },
        "lastUpdated": {
          "type": "string",
          "description": "The timestamp when the last known location coordinates (latitude and longitude) were recorded.",
          "format": "date-time"
        },
        "expiresAt": {
          "type": "string",
          "description": "An optional timestamp indicating when the tracking session is scheduled to automatically deactivate.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "trackingCode",
        "transmitterUserId",
        "isActive",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores non-sensitive user profile information. The document ID `{userId}` must match the authenticated user's `uid`. This structure ensures path-based ownership for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching `request.auth.uid`."
            }
          ]
        }
      },
      {
        "path": "/trackerSessions/{trackingCode}",
        "definition": {
          "entityName": "TrackerSession",
          "schema": {
            "$ref": "#/backend/entities/TrackerSession"
          },
          "description": "Represents an active or historical tracking session. The document ID is the unique `trackingCode`, which receivers use for direct access. Includes denormalized `transmitterUserId` for owner authorization and `isActive` for receiver read access, ensuring authorization independence. `list` operations are strictly limited to support QAPs and prevent code enumeration.",
          "params": [
            {
              "name": "trackingCode",
              "description": "The unique alphanumeric code generated for this tracking session, also serving as the document ID."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to be highly secure, scalable, and easily debuggable, prioritizing authorization independence and supporting efficient query access patterns (QAPs). \n\n**User Profiles (`/users/{userId}`)**: User profiles are stored in a top-level `users` collection, with each document ID matching the authenticated user's `uid` (`userId`). This establishes clear path-based ownership, making security rules for personal data simple (`request.auth.uid == userId`) and ensuring authorization independence as no parent `get()` calls are needed to verify ownership.\n\n**Tracker Sessions (`/trackerSessions/{trackingCode}`)**: This is the core collection for the application's functionality. Each `TrackerSession` document is stored in a top-level `trackerSessions` collection, with its document ID explicitly set to the `trackingCode` generated by the AI. This design choice is critical for several reasons:\n\n1.  **Authorization Independence for Transmitters**: The `transmitterUserId` (the owner of the session) is denormalized and stored directly within each `TrackerSession` document. This allows security rules to verify ownership directly (`request.auth.uid == resource.data.transmitterUserId`) without needing to fetch any parent user document. This enables atomic operations and simplifies rule logic.\n2.  **QAP Support for Receivers**: Receivers need to find a `TrackerSession` by its unique `trackingCode`. By making the `trackingCode` the document ID, receivers can perform a direct `get()` operation (`db.collection('trackerSessions').doc(enteredCode).get()`). Firestore security rules can then grant `read` access based on properties *within that specific document* (e.g., `resource.data.isActive == true`) and `request.auth.uid != null`. This method is highly performant and secure, as it prevents costly and insecure `list` queries across all sessions. Crucially, it adheres to the QAP principle by disallowing general `list` operations on the `trackerSessions` collection to prevent enumeration of active codes.\n3.  **Addressing 'Kod hatalı'**: The current error 'Kod hatalı' (Code incorrect) for receivers is directly addressed by this structure. If the `get()` fails, it will be due to the `trackingCode` not existing as a document ID, the session not being `isActive`, or the security rules explicitly denying access. The proposed rules would allow reads for active sessions when an authenticated receiver provides the correct `trackingCode` (as the document ID).\n\n**Structural Segregation**: Each collection maintains a homogeneous security posture. The `users` collection contains only user profiles, and the `trackerSessions` collection contains only tracking sessions. There is no mixing of public/private data within the same collection that would complicate security rules.\n\n**Access Modeling**: Path-based ownership is used for `UserProfile`. For `TrackerSession`, a hybrid approach is used: `transmitterUserId` for owner (CUD) access is denormalized, and the `trackingCode` itself serves as the direct access key for `receiver` (read) access. This balances the needs of both user roles efficiently and securely."
  }
}